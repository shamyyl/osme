<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>Визуализатор данных регионов</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <script type="text/javascript"
            src="http://api-maps.yandex.ru/2.0/?lang=ru-RU&load=package.full&mode=release"></script>
    <script type="text/javascript" src="combiner.js"></script>
    <script type="text/javascript" src="countor.js"></script>
    <script type="text/javascript" src="../tmp-data/result.js"></script>
    <script type="text/javascript" src="http://yandex.st/jquery/1.8.2/jquery.min.js"></script>
</head>

<body class="yui3-skin-sam">
<table width=100% height=800>
    <tr valign=top>
        <td>
            <div id="map" style="height: 700px; width: 100%; position: relative;"></div>
            <div id='waypoints'></div>
        </td>
        <td width=200px>
            <div class='info' style='width:200px;height:200px;overflow:hidden;overflow-y: auto;font-size:12px'></div>
            <div style='max-height:700px;overflow-y:auto;overflow-x:hidden;font-size:12px;'>
                <ul id='regions' style='padding:0;margin:0'></ul>
            </div>
        </td>
    </tr>
</table>

</body>

<script type="text/javascript">
    ymaps.ready(function () {
        var geoMap = new ymaps.Map('map', {
            center: [0, 0],
            type: "yandex#map",
            zoom: 2
        });
        var geoObject = 0;

        //96119650
        //134545304
        //134546603

        var regions = osme.regions;
        var ul = $("#regions");

        for (var i  in osme.ways) {
            var way = osme.ways[i].nodes;
            if (osme.ways[i].tags && osme.ways[i].tags.closure_segment) {
                osme.ways[i].nodes = [];
            }
        }

        for (var i = 0, l = regions.length; i < l; ++i) {

            //if(regions[i].id==151231)
            (function (i) {
                var region = regions[i];
                region.metadata = countor.build(regions[i], osme.ways);
                var li = $("<li>" + region.id + ') ' + region.tags.name + "</li>").appendTo(ul);
                li.click(function () {
                    showRegion(i, true);
                })
            })(i);
        }

        function makeText (tags) {
            var lines = [];
            for (var i in tags) {
                lines.push('<tr><td>' + i + '</td><td>' + tags[i] + '</td></tr>');
            }
            return '<table>' + lines.join('\n') + '</table>';
        }

        function showWaypoints (ways, exclude) {
            var sets = {
                inner: {},
                outer: {}
            };
            for (var i = 0, l = ways.length; i < l; ++i) {
                var wayid = ways[i];
                for (var j = 0, lj = regions.length; j < lj; ++j) {
                    if (j != exclude && regions[j].metadata) {
                        if (regions[j].metadata.hash[wayid]) {
                            sets.inner[j] = sets.inner[j] || [];
                            sets.inner[j].push(wayid);
                        }
                        if (regions[j].metadata.hash[-wayid]) {
                            sets.outer[j] = sets.outer[j] || [];
                            sets.outer[j].push(wayid);
                        }
                    }
                }
            }
            var inner = [];
            for (var i in sets.inner) {
                inner.push("<a href='#' class='regionLink' data-rid=" + i + " data-ways='" + sets.inner[i].join(',') + "'>" + regions[i].tags.name + '|' + sets.inner[i].length + "</a>");
            }
            var outer = [];
            for (var i in sets.outer) {
                outer.push("<a href='#' class='regionLink' data-rid=" + i + " data-ways='" + sets.outer[i].join(',') + "'>" + regions[i].tags.name + '|' + sets.outer[i].length + "</a>");
            }
            $("#waypoints").html("inner:" + inner.join(', ') + "<br/>outer:" + outer.join(", "));
        }

        function showRegion (i, extdata) {

            var ds = regions[i].metadata,
                    coordinates = ds.coordinates;

            if (extdata) {
                $(".info").html(ds.coordinates.length + ' countors<br/>' + makeText(regions[i].tags));
                showWaypoints(ds.ways, i);
            }


            if (geoObject) {
                geoMap.geoObjects.remove(geoObject);
            }

            geoObject = new ymaps.GeoObjectCollection();

            for (var j = 0, l = coordinates.length; j < l; ++j) {
                var geometryLine = {
                    type: 'Polygon',
                    coordinates: [coordinates[j]],
                    fillRule: 'nonZero'
                };

                if (j == 5) {
                    console.log(coordinates[j]);
                }

                var region = new ymaps.GeoObject({
                    geometry: geometryLine,
                    properties: {
                        hintContent: regions[i].tags.name + ":" + j
                    }
                }, {
                    strokeColor: j % 2 ? '#ff0000' : '#0066ff',
                    fillColor: j % 2 ? '#0066ff' : '#ff0000',
                    opacity: 0.6,
                    strokeWidth: 2
                });
                geoObject.add(region);
            }
            geoMap.geoObjects.add(geoObject);
        }

        var geoLines = [];

        function showWays (ways) {
            for (var i in geoLines) {
                geoMap.geoObjects.remove(geoLines[i]);
            }
            geoLines = [];
            for (var i in ways) {
                var geometryLine = {
                    type: 'LineString',
                    coordinates: osme.ways[Math.abs(ways[i])].nodes
                };
                var geoLine = new ymaps.GeoObject({
                    geometry: geometryLine,
                    properties: {
                        hintContent: ways[i]
                    }
                }, {
                    strokeColor: '#00ff00',
                    strokeWidth: 6

                });
                geoMap.geoObjects.add(geoLine);
                geoLines.push(geoLine);

            }
        }

        jQuery(function () {
            jQuery("body")
                    .delegate('.regionLink', 'click', function () {
                        //showRegion($(this).attr('data-rid'), false);
                        showWays($(this).attr('data-ways').split(','));
                        return false;
                    })
        });
    });
</script>
</html>
